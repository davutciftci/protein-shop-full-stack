generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int              @id(map: "users_pk") @default(autoincrement())
  firstName      String           @map("first_name")
  lastName       String           @map("last_name")
  tcNo           String           @unique(map: "users_unique_1") @map("tc_no") @db.VarChar
  hashedPassword String           @map("hashed_password") @db.VarChar
  birthDay       DateTime         @map("birth_date") @db.Date
  email          String           @unique(map: "users_unique") @map("email")
  role           UserRole         @default(CUSTOMER) @map("role")
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  comments       ProductComment[]
  addresses      UserAddress[]
  cart           Cart?

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  slug        String    @unique
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  Product     Product[]

  @@map("categories")
}

model Product {
  id          Int              @id @default(autoincrement())
  name        String
  slug        String           @unique
  description String?
  price       Decimal          @db.Decimal(10, 2)
  stockCount  Int              @default(0) @map("stock_count")
  isActive    Boolean          @default(true) @map("is_active")
  categoryId  Int              @map("category_id")
  category    Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  variants    ProductVariant[]
  photos      ProductPhoto[]
  comments    ProductComment[]

  //ileride order ilişkisi eklenecek
  //cartItems CartItem[]
  //orderItems OrderItem[]

  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

model ProductVariant {
  id         Int      @id @default(autoincrement())
  name       String
  sku        String   @unique
  price      Decimal  @db.Decimal(10, 2)
  stockCount Int      @default(0) @map("stock_count")
  isActive   Boolean  @default(true) @map("is_active")
  attributes Json?
  productId  Int      @map("product_id")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // İleride eklenecek ilişkiler:
  // cartItems    CartItem[]
  // orderItems   OrderItem[]
  CartItem CartItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductPhoto {
  id           Int      @id @default(autoincrement())
  url          String
  altText      String?  @map("alt_text")
  isPrimary    Boolean  @default(false) @map("is_primary")
  displayOrder Int      @default(0) @map("display_order")
  productId    Int      @map("product_id")
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([isPrimary])
  @@map("product_photos")
}

model ProductComment {
  id         Int      @id @default(autoincrement())
  rating     Int
  comment    String   @db.Text
  isApproved Boolean  @default(false) @map("is_approved")
  userId     Int      @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId  Int      @map("product_id")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([userId])
  @@index([isApproved])
  @@map("product_comments")
}

model UserAddress {
  id Int @id @default(autoincrement())

  title        String
  fullName     String   @map("full_name")
  phoneNumber  String   @map("phone_number") @db.VarChar(20)
  addressLine1 String   @map("address_line_1") @db.Text
  city         String
  district     String
  postalCode   String?  @map("postal_code") @db.VarChar(10)
  isDefault    Boolean  @default(false) @map("is_default")
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // İleride eklenecek ilişkiler:
  // orders        Order[]

  @@index([userId])
  @@index([isDefault])
  @@map("user_addresses")
}

model Cart {
  id Int @id @default(autoincrement())

  // Foreign key
  userId Int  @unique @map("user_id") // Her kullanıcının bir sepeti
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // İlişkiler
  items CartItem[]

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id Int @id @default(autoincrement())

  // Miktar
  quantity Int @default(1)

  // Foreign keys
  cartId Int  @map("cart_id")
  cart   Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  variantId Int            @map("variant_id")
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Bir sepette aynı varyant sadece bir kez olabilir (miktar artırılır)
  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([variantId])
  @@map("cart_items")
}
