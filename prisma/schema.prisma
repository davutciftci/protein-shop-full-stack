generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int              @id(map: "users_pk") @default(autoincrement())
  firstName      String           @map("first_name")
  lastName       String           @map("last_name")
  tcNo           String           @unique(map: "users_unique_1") @map("tc_no") @db.VarChar
  hashedPassword String           @map("hashed_password") @db.VarChar
  birthDay       DateTime         @map("birth_date") @db.Date
  email          String           @unique(map: "users_unique") @map("email")
  role           UserRole         @default(CUSTOMER) @map("role")
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  comments       ProductComment[]
  addresses      UserAddress[]
  cart           Cart?
  orders         Order[]

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  slug        String    @unique
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  Product     Product[]

  @@map("categories")
}

model Product {
  id          Int              @id @default(autoincrement())
  name        String
  slug        String           @unique
  description String?
  price       Decimal          @db.Decimal(10, 2)
  stockCount  Int              @default(0) @map("stock_count")
  isActive    Boolean          @default(true) @map("is_active")
  categoryId  Int              @map("category_id")
  category    Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)
  variants    ProductVariant[]
  photos      ProductPhoto[]
  comments    ProductComment[]
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

model ProductVariant {
  id         Int         @id @default(autoincrement())
  name       String
  sku        String      @unique
  price      Decimal     @db.Decimal(10, 2)
  stockCount Int         @default(0) @map("stock_count")
  isActive   Boolean     @default(true) @map("is_active")
  attributes Json?
  productId  Int         @map("product_id")
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductPhoto {
  id           Int      @id @default(autoincrement())
  url          String
  altText      String?  @map("alt_text")
  isPrimary    Boolean  @default(false) @map("is_primary")
  displayOrder Int      @default(0) @map("display_order")
  productId    Int      @map("product_id")
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([isPrimary])
  @@map("product_photos")
}

model ProductComment {
  id         Int      @id @default(autoincrement())
  rating     Int
  comment    String   @db.Text
  isApproved Boolean  @default(false) @map("is_approved")
  userId     Int      @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId  Int      @map("product_id")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([userId])
  @@index([isApproved])
  @@map("product_comments")
}

model UserAddress {
  id           Int      @id @default(autoincrement())
  title        String
  fullName     String   @map("full_name")
  phoneNumber  String   @map("phone_number") @db.VarChar(20)
  addressLine1 String   @map("address_line_1") @db.Text
  city         String
  district     String
  postalCode   String?  @map("postal_code") @db.VarChar(10)
  isDefault    Boolean  @default(false) @map("is_default")
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  orders       Order[]

  @@index([userId])
  @@index([isDefault])
  @@map("user_addresses")
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique @map("user_id")
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  items     CartItem[]

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        Int            @id @default(autoincrement())
  quantity  Int            @default(1)
  cartId    Int            @map("cart_id")
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variantId Int            @map("variant_id")
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  Product   Product?       @relation(fields: [productId], references: [id])
  productId Int?

  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([variantId])
  @@map("cart_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

model Order {
  id              Int          @id @default(autoincrement())
  orderNumber     String       @unique @map("order_number")
  status          OrderStatus  @default(PENDING)
  subtotal        Decimal      @db.Decimal(10, 2)
  shippingCost    Decimal      @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  taxAmount       Decimal      @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount     Decimal      @map("total_amount") @db.Decimal(10, 2)
  shippingAddress Json         @map("shipping_address")
  paymentMethod   String?      @map("payment_method")
  paymentStatus   String?      @default("pending") @map("payment_status")
  paidAt          DateTime?    @map("paid_at")
  trackingNumber  String?      @map("tracking_number")
  shippedAt       DateTime?    @map("shipped_at")
  deliveredAt     DateTime?    @map("delivered_at")
  cancelledAt     DateTime?    @map("cancelled_at")
  cancelReason    String?      @map("cancel_reason")
  user            User?        @relation(fields: [userId], references: [id])
  address         UserAddress? @relation(fields: [addressId], references: [id])
  addressId       Int?         @map("address_id")
  userId          Int?
  items           OrderItem[]
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)
  Payment         Payment?
}

model OrderItem {
  id              Int            @id @default(autoincrement())
  productName     String         @map("product_name")
  variantName     String         @map("variant_name")
  sku             String
  price           Decimal        @db.Decimal(10, 2)
  quantity        Int
  subtotal        Decimal        @db.Decimal(10, 2)
  productSnapshot Json           @map("product_snapshot")
  orderId         Int            @map("order_id")
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId       Int            @map("variant_id")
  variant         ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  Product         Product?       @relation(fields: [productId], references: [id])
  productId       Int?

  @@index([orderId])
  @@index([variantId])
  @@map("order_items")
}

model Payment {
  id              Int      @id @default(autoincrement())
  paymentId       String   @unique @map("payment_id")
  conversationId  String   @map("conversation_id")
  amount          Decimal  @db.Decimal(10, 2)
  paidPrice       Decimal  @map("paid_price") @db.Decimal(10, 2)
  currency        String   @default("TRY")
  status          String
  paymentStatus   String?  @map("payment_status")
  fraudStatus     Int?     @map("fraud_status")
  cardType        String?  @map("card_type")
  cardAssociation String?  @map("card_association")
  cardFamily      String?  @map("card_family")
  binNumber       String?  @map("bin_number")
  lastFourDigits  String?  @map("last_four_digits")
  iyzicoResponse  Json?    @map("iyzico_response")
  orderId         Int      @unique @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([paymentId])
  @@index([conversationId])
  @@index([status])
  @@map("payments")
}
